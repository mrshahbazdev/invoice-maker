<?php namespace App\Livewire\Admin\Settings; use Livewire\Component;
use App\Services\AiService;
use Illuminate\Support\Facades\Log; class Languages extends Component
{ public $enabledLanguages = []; public $customLocales = []; public $baseLocales = [ 'en' => 'English', 'de' => 'Deutsch', 'es' => 'Español', 'fr' => 'Français', 'it' => 'Italiano', 'pt' => 'Português', 'ar' => 'العربية', 'zh' => '中文', 'ja' => '日本語', 'ru' => 'Русский', 'nl' => 'Nederlands', 'tr' => 'Türkçe', 'pl' => 'Polski', ]; public $editingLocale = null; public $translations = []; public $baseTranslations = []; public $search = ''; // New Language public $isAddingLanguage = false; public $newLanguageCode = ''; public $newLanguageName = ''; // AI Translation public $isTranslating = false; public function mount() { $defaultLanguages = [ 'en' => 'English', 'de' => 'Deutsch', 'es' => 'Español', 'fr' => 'Français', 'it' => 'Italiano', 'pt' => 'Português', 'ar' => 'العربية', 'zh' => '中文', 'ja' => '日本語', 'ru' => 'Русский' ]; $this->enabledLanguages = \App\Models\Setting::get('site.enabled_languages', $defaultLanguages); $this->customLocales = \App\Models\Setting::get('site.custom_locales', []); $this->loadBaseTranslations(); } #[\Livewire\Attributes\Computed] public function availableLocales() { return array_merge($this->baseLocales, $this->customLocales); } public function toggleLanguage($code, $name) { if ($code === 'en') return; // Cannot disable base language if (isset($this->enabledLanguages[$code])) { unset($this->enabledLanguages[$code]); if ($this->editingLocale === $code) { $this->editingLocale = null; } } else { $this->enabledLanguages[$code] = $name; $path = base_path("lang/{$code}.json"); if (!\Illuminate\Support\Facades\File::exists($path)) { \Illuminate\Support\Facades\File::put($path, json_encode([], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)); } } \App\Models\Setting::set('site.enabled_languages', $this->enabledLanguages, 'json'); session()->flash('message', 'Language status updated.'); } public function showAddLanguageModal() { $this->newLanguageCode = ''; $this->newLanguageName = ''; $this->isAddingLanguage = true; } public function addLanguage() { $this->validate([ 'newLanguageCode' => 'required|string|min:2|max:5', 'newLanguageName' => 'required|string|max:50', ]); $code = strtolower(trim($this->newLanguageCode)); $name = trim($this->newLanguageName); if (isset($this->availableLocales[$code])) { session()->flash('error', 'Language code already exists.'); return; } $this->customLocales[$code] = $name; \App\Models\Setting::set('site.custom_locales', $this->customLocales, 'json'); // Automatically enable it $this->enabledLanguages[$code] = $name; \App\Models\Setting::set('site.enabled_languages', $this->enabledLanguages, 'json'); // Create empty translation file $path = base_path("lang/{$code}.json"); if (!\Illuminate\Support\Facades\File::exists($path)) { \Illuminate\Support\Facades\File::put($path, json_encode([], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)); } $this->isAddingLanguage = false; session()->flash('message', "{$name} added successfully."); } public function autoTranslate() { if (!$this->editingLocale) return; $targetName = $this->availableLocales[$this->editingLocale] ?? $this->editingLocale; // Skip keys that already have a non-empty translation $keysToTranslate = []; $stringsToTranslate = []; foreach ($this->baseTranslations as $key => $val) { if (empty(trim($this->translations[$key] ?? ''))) { $keysToTranslate[] = $key; $stringsToTranslate[$key] = $val; } } if (empty($stringsToTranslate)) { session()->flash('message', 'All phrases are already translated.'); return; } $this->isTranslating = true; try { $aiService = new AiService(); $translated = $aiService->translateJson($stringsToTranslate, $targetName); foreach ($translated as $key => $val) { if (isset($this->baseTranslations[$key])) { $this->translations[$key] = $val; } } $this->saveTranslations(false); session()->flash('message', 'Missing translations were generated by AI successfully.'); } catch (\Exception $e) { Log::error($e->getMessage()); session()->flash('error', 'AI Translation failed. Please check your AI API keys in settings.'); } $this->isTranslating = false; } protected function loadBaseTranslations() { $path = base_path('lang/en.json'); if (\Illuminate\Support\Facades\File::exists($path)) { $this->baseTranslations = json_decode(\Illuminate\Support\Facades\File::get($path), true) ?? []; } } public function editTranslations($code) { $this->editingLocale = $code; $this->search = ''; $path = base_path("lang/{$code}.json"); $currentTranslations = []; if (\Illuminate\Support\Facades\File::exists($path)) { $currentTranslations = json_decode(\Illuminate\Support\Facades\File::get($path), true) ?? []; } $this->translations = []; foreach ($this->baseTranslations as $key => $baseValue) { $this->translations[$key] = $currentTranslations[$key] ?? ''; } } public function saveTranslations($showFlash = true) { if (!$this->editingLocale) return; $path = base_path("lang/{$this->editingLocale}.json"); $toSave = []; foreach ($this->translations as $key => $value) { if (trim($value) !== '') { $toSave[$key] = $value; } } \Illuminate\Support\Facades\File::put($path, json_encode($toSave, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)); if ($showFlash) { session()->flash('message', 'Translations saved successfully.'); } } #[\Livewire\Attributes\Layout('layouts.admin', ['title' => 'Language & Localization'])] public function render() { $filteredBase = $this->baseTranslations; if ($this->search) { $filteredBase = array_filter($this->baseTranslations, function ($key) { return stripos($key, $this->search) !== false; }, ARRAY_FILTER_USE_KEY); } return view('livewire.admin.settings.languages', [ 'filteredKeys' => array_keys($filteredBase) ]); }
}
